{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
    <div class="row mb-4"><div class="col-md-12">
        <nav aria-label="breadcrumb"><ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('projects.client_projects', client_id=project.client_id) }}">Projects</a>
</li>
            <li class="breadcrumb-item active">{{ project.title }}</li>
        </ol></nav>
        
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2>{{ project.title }}</h2>
                <p class="text-muted">{{ project.description }}</p>
            </div>
            <div>
                {% if project.status != 'Completed' %}
                <a href="{{ url_for('projects.complete_project', project_id=project._id) }}" 
                   class="btn btn-success btn-sm me-2"
                   onclick="return confirm('Mark project as Completed and generate Invoice?')">
                    <i class="bi bi-check2-all"></i> Complete & Invoice
                </a>
                {% endif %}
                
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    <i class="bi bi-plus-lg"></i> Add Task
                </button>
            </div>
        </div>
    </div></div>

    <div class="card shadow-sm"><div class="card-body">
        <h5>Tasks</h5>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead><tr><th style="width: 50px;">Status</th><th>Description</th><th style="width: 100px;">Hours</th><th style="width: 100px;" class="text-end">Actions</th></tr></thead>
                <tbody>
                    {% for task in tasks %}
                    <tr class="{% if task.status == 'Done' %}table-light text-muted{% endif %}">
                        <td>
                            <a href="{{ url_for('projects.toggle_task', task_id=task._id) }}" class="text-decoration-none">
                                {% if task.status == 'Done' %}
                                <i class="bi bi-check-circle-fill text-success fs-5"></i>
                                {% else %}
                                <i class="bi bi-circle text-secondary fs-5"></i>
                                {% endif %}
                            </a>
                        </td>
                        <td>
                            {% if task.status == 'Done' %}
                                <del>{{ task.description }}</del>
                            {% else %}
                                {{ task.description }}
                            {% endif %}
                        </td>
                        <td>{{ task.hours }} hrs</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-secondary border-0" data-bs-toggle="modal" data-bs-target="#editTaskModal{{ task._id }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <a href="{{ url_for('projects.delete_task', task_id=task._id) }}" class="btn btn-sm btn-outline-danger border-0" onclick="return confirm('Delete this task?')">
                                <i class="bi bi-trash"></i>
                            </a>

                            <div class="modal fade" id="editTaskModal{{ task._id }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <form action="{{ url_for('projects.edit_task', task_id=task._id) }}" method="POST">
                                        <div class="modal-content">
                                            <div class="modal-header"><h6 class="modal-title">Edit Task</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                                            <div class="modal-body text-start">
                                                <div class="mb-3">
                                                    <label class="form-label small">Description</label>
                                                    <input type="text" name="description" class="form-control" value="{{ task.description }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label small">Hours</label>
                                                    <input type="number" step="0.5" name="hours" class="form-control" value="{{ task.hours }}" required>
                                                </div>
                                            </div>
                                            <div class="modal-footer"><button type="submit" class="btn btn-primary btn-sm">Save Changes</button></div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="text-center text-muted py-4">No tasks found. Add one manually or use AI next time!</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div></div>
</div>

<div class="modal fade" id="addTaskModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('projects.add_task', project_id=project._id) }}" method="POST">
                <div class="modal-header"><h5 class="modal-title">New Task</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" name="description" class="form-control mb-3" placeholder="Task Description" required>
                    <input type="number" step="0.5" name="hours" class="form-control mb-3" placeholder="Estimated Hours" required>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary">Add Task</button></div>
            </form>
        </div>
    </div>
</div>
{% endblock %}