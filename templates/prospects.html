{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Active Prospects</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProspectModal">
        <i class="bi bi-plus-lg"></i> Add Prospect
    </button>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Prospect</th>
                        <th>Stage</th>
                        <th>Value</th>
                        <th>Prob.</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in prospects %}
                    {% if p.stage != 'Won' %}
                    <tr>
                        <td>
                            <div class="fw-bold">{{ p.name }}</div>
                            <div class="text-muted small">{{ p.company }}</div>
                        </td>
                        <td>
                            <form action="{{ url_for('update_prospect_stage', prospect_id=p._id) }}" method="POST">
                                <select name="stage" class="form-select form-select-sm" onchange="this.form.submit()"
                                        style="width: 150px; font-size: 0.85rem; font-weight: 500;
                                        {% if p.stage == 'Negotiating' %}
                                            background-color: #fff3cd; color: #664d03; border-color: #ffecb5;
                                        {% elif p.stage == 'Verbal Agreement' %}
                                            background-color: #d1e7dd; color: #0f5132; border-color: #badbcc;
                                        {% elif p.stage == 'Closed Lost' %}
                                            background-color: #f8d7da; color: #842029; border-color: #f5c2c7;
                                        {% else %}
                                            background-color: #f8f9fa; color: #212529; border-color: #ced4da;
                                        {% endif %}">
                                    
                                    <option value="Discovery" {% if p.stage == 'Discovery' %}selected{% endif %}>üîç Discovery</option>
                                    <option value="Proposal Sent" {% if p.stage == 'Proposal Sent' %}selected{% endif %}>üìÑ Proposal Sent</option>
                                    <option value="Negotiating" {% if p.stage == 'Negotiating' %}selected{% endif %}>üí¨ Negotiating</option>
                                    <option value="Verbal Agreement" {% if p.stage == 'Verbal Agreement' %}selected{% endif %}>ü§ù Verbal Agmt</option>
                                    <option value="Closed Lost" {% if p.stage == 'Closed Lost' %}selected{% endif %}>‚ùå Closed Lost</option>
                                </select>
                            </form>
                        </td>
                        <td>
                            <form action="{{ url_for('update_prospect_value', prospect_id=p._id) }}" method="POST">
                                <div class="input-group input-group-sm" style="min-width: 100px;">
                                    <span class="input-group-text bg-light text-muted border-0">$</span>
                                    <input type="number" name="value" value="{{ p.value }}" 
                                        class="form-control border-0 bg-transparent fw-bold" 
                                        onchange="this.form.submit()"
                                        style="box-shadow: none;">
                                </div>
                            </form>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1" style="height: 6px;">
                                    <div class="progress-bar {% if p.probability > 70 %}bg-success{% else %}bg-primary{% endif %}" 
                                         role="progressbar" style="width: {{ p.probability }}%"></div>
                                </div>
                                <span class="ms-2 small">{{ p.probability }}%</span>
                            </div>
                        </td>
                        <td>
                            <a href="{{ url_for('convert_prospect', prospect_id=p._id) }}" 
                               class="btn btn-sm btn-success me-1" 
                               title="Mark as Won"
                               onclick="return confirm('Mark this deal as WON? This will create a new Client.')">
                                <i class="bi bi-trophy-fill"></i> Win
                            </a>
                            
                            <a href="{{ url_for('delete_prospect', prospect_id=p._id) }}" 
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Delete this prospect?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endif %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            No active prospects. Go to Leads and convert someone!
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addProspectModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('prospects') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">New Prospect</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" name="name" class="form-control mb-3" placeholder="Name" required>
                    <input type="text" name="company" class="form-control mb-3" placeholder="Company" required>
                    <input type="email" name="email" class="form-control mb-3" placeholder="Email">
                    <input type="number" name="value" class="form-control mb-3" placeholder="Estimated Value ($)">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Prospect</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}