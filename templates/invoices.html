{% extends "base.html" %}
{% block content %}
<script src="{{ url_for('static', filename='js/invoice_project_filter.js') }}"></script>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Invoices</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">
        Create Invoice
    </button>
</div>

<div class="card shadow-sm">
<div class="card-body">
<div class="table-responsive">
<table class="table table-hover align-middle">

    <thead class="table-light">
        <tr>
            <th>Invoice #</th>
            <th>Client</th>
            <th>Due</th>
            <th>Amount (Base + GST)</th>
            <th>Total</th>
            <th>Payment</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        {% for inv in invoices %}
        {% set gst = inv.amount | gst %}
        <tr>
            <td>{{ inv.invoice_number }}</td>

            <td>
                {{ inv.client_name }}<br>
                <small class="text-muted">{{ inv.project_title }}</small>
            </td>

            <td>{{ inv.due_date | date_format }}</td>

            <td>
                ₹{{ gst.base | round(2) }}<br>
                <small class="text-muted">
                    CGST (9%): ₹{{ gst.cgst | round(2) }}<br>
                    SGST (9%): ₹{{ gst.sgst | round(2) }}
                </small>
            </td>

            <td class="fw-bold">
                ₹{{ gst.total | round(2) }}
            </td>

            <td>
                <span class="badge bg-secondary">
                    {{ inv.payment_mode | default("—") }}
                </span>
            </td>

            <td>
                <span class="badge {% if inv.status == 'Paid' %}bg-success{% else %}bg-danger{% endif %}">
                    {{ inv.status }}
                </span>
            </td>

            <td>
                <a href="{{ url_for('invoices.view_invoice', invoice_id=inv._id) }}"
                   target="_blank"
                   class="btn btn-sm btn-outline-primary">View</a>

                {% if inv.status != 'Paid' %}
                <a href="{{ url_for('invoices.mark_invoice_paid', invoice_id=inv._id) }}"
                   class="btn btn-sm btn-success">Pay</a>
                {% endif %}

                <a href="{{ url_for('invoices.delete_invoice', invoice_id=inv._id) }}"
                   class="btn btn-sm btn-outline-danger">Del</a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="7" class="text-center py-4">No invoices.</td>
        </tr>
        {% endfor %}
    </tbody>

</table>
</div>
</div>
</div>

<!-- Modal stays unchanged -->
<div class="modal fade" id="addInvoiceModal">
<div class="modal-dialog">
<div class="modal-content">
<form action="{{ url_for('invoices.invoices') }}" method="POST">
    <div class="modal-header">
        <h5 class="modal-title">New Invoice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <label class="form-label small text-muted">Client</label>
        <select name="client_name" class="form-select mb-3" required>
            {% for c in clients %}
            <option value="{{ c.name }}">{{ c.name }}</option>
            {% endfor %}
            <option value="Manual">Manual Client</option>
        </select>

        <label class="form-label small text-muted">Project</label>
        <select name="project_title" class="form-select mb-3" required>
            {% for p in projects %}
            <option
                value="{{ p.title }}"
                data-client="{{ p.client_name }}">
                {{ p.title }}
            </option>
            {% endfor %}
            <option value="General Service">General Service</option>
        </select>

        <input type="number" step="0.01" name="amount"
               class="form-control mb-3"
               placeholder="Amount (₹)" required>
        
        <label class="form-label small text-muted">Payment Mode</label>
        <select name="payment_mode" class="form-select mb-3" required>
            <option value="UPI">UPI</option>
            <option value="Bank Transfer">Bank Transfer</option>
            <option value="Cash">Cash</option>
        </select>

        <label class="form-label small text-muted">Due Date</label>
        <input type="date" name="due_date"
               class="form-control mb-3" required>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Generate</button>
    </div>
</form>
</div>
</div>
</div>

{% endblock %}